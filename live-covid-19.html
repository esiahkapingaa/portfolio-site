<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COVID-19 WHO-Style Map - Date Range</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    section {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    #map {
      height: 600px;
      width: 100%;
      border-radius: 8px;
    }
    .info-panel {
      margin-top: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 8px;
    }
    select {
      padding: 5px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .legend {
      list-style: none;
      padding-left: 0;
    }
    .legend li {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    .legend i {
      width: 14px;
      height: 14px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 3px;
    }
  </style>
</head>
<body>

<section>
  <h2>COVID-19 Cases by Country (WHO Style)</h2>
  
  <label for="range">Select Time Range:</label>
  <select id="range">
    <option value="7">Last 7 Days</option>
    <option value="30">Last 30 Days</option>
    <option value="365">Last 365 Days</option>
    <option value="all">All Time</option>
  </select>

  <div id="map"></div>

  <div class="info-panel">
    <h3>WHO Region Color Codes</h3>
    <p>This map shows reported COVID-19 cases by selected date range, using WHO regional colors:</p>
    <ul class="legend">
      <li><i style="background:#7b4bc2"></i> Africa</li>
      <li><i style="background:#ff7f0e"></i> Americas</li>
      <li><i style="background:#d62728"></i> Eastern Mediterranean</li>
      <li><i style="background:#1f77b4"></i> Europe</li>
      <li><i style="background:#2ca02c"></i> South-East Asia</li>
      <li><i style="background:#bcbd22"></i> Western Pacific</li>
    </ul>
  </div>
</section>

<script>
const map = L.map('map').setView([20, 0], 2);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

const regionColors = {
  "Africa": "#7b4bc2",
  "Americas": "#ff7f0e",
  "Eastern Mediterranean": "#d62728",
  "Europe": "#1f77b4",
  "South-East Asia": "#2ca02c",
  "Western Pacific": "#bcbd22",
  "Other": "#999"
};

// WHO Region mapping
const countryRegionMap = {
  // Africa
  "Algeria": "Africa", "Nigeria": "Africa", "South Africa": "Africa", "Kenya": "Africa", "Ethiopia": "Africa", "Egypt": "Eastern Mediterranean",
  // Americas
  "United States": "Americas", "Brazil": "Americas", "Canada": "Americas", "Mexico": "Americas", "Argentina": "Americas", "Chile": "Americas",
  // Eastern Mediterranean
  "Pakistan": "Eastern Mediterranean", "Iran": "Eastern Mediterranean", "Afghanistan": "Eastern Mediterranean", "Saudi Arabia": "Eastern Mediterranean",
  // Europe
  "France": "Europe", "Germany": "Europe", "Italy": "Europe", "Spain": "Europe", "United Kingdom": "Europe", "Russia": "Europe", "Ukraine": "Europe",
  // South-East Asia
  "India": "South-East Asia", "Indonesia": "South-East Asia", "Thailand": "South-East Asia", "Bangladesh": "South-East Asia", "Nepal": "South-East Asia",
  // Western Pacific
  "China": "Western Pacific", "Japan": "Western Pacific", "Australia": "Western Pacific", "Philippines": "Western Pacific", "Vietnam": "Western Pacific", "New Zealand": "Western Pacific"
};

let markers = [];

async function loadData(days) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const countriesRes = await fetch("https://disease.sh/v3/covid-19/countries");
  const countries = await countriesRes.json();

  for (let c of countries) {
    const histRes = await fetch(`https://disease.sh/v3/covid-19/historical/${c.country}?lastdays=${days === 'all' ? 1000 : days}`);
    const hist = await histRes.json();

    if (!hist.timeline || !hist.timeline.cases) continue;

    const casesTimeline = Object.values(hist.timeline.cases);
    let casesCount;

    if (days === 'all') {
      casesCount = casesTimeline[casesTimeline.length - 1];
    } else {
      casesCount = casesTimeline[casesTimeline.length - 1] - casesTimeline[0];
    }

    const region = countryRegionMap[c.country] || "Other";
    const color = regionColors[region];

    const radius = Math.sqrt(casesCount) / 300; // adjusted size

    const circle = L.circleMarker([c.countryInfo.lat, c.countryInfo.long], {
      radius: radius,
      fillColor: color,
      color: "#555",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.7
    }).bindPopup(
      `<b>${c.country}</b><br>Cases in range: ${casesCount.toLocaleString()}<br>Region: ${region}`
    );

    circle.on("mouseover", function() { this.openPopup(); });
    circle.on("mouseout", function() { this.closePopup(); });

    markers.push(circle);
    circle.addTo(map);
  }
}

loadData(7);

document.getElementById("range").addEventListener("change", (e) => {
  loadData(e.target.value);
});
</script>
</body>
</html>
